# Cyber Forest CTF Chapter 03: The Encrypted Vault

I'll create a new CTF challenge that builds upon the previous one with more advanced cryptography concepts and a deeper file system exploration.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌲 Cyber Forest CTF Chapter 03: The Encrypted Vault</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Source+Code+Pro:wght@300;400;600&display=swap');
        
        :root {
            --main-bg: #0a0a12;
            --terminal-bg: #0a0a18;
            --terminal-border: #ff2a7f;
            --terminal-glow: rgba(255, 42, 127, 0.5);
            --text-primary: #00ffcc;
            --text-secondary: #ff2a7f;
            --text-command: #66ff00;
            --text-error: #ff2a7f;
            --text-success: #00ff95;
            --text-warning: #ffcc00;
            --accent-1: #ff2a7f;
            --accent-2: #7f2aff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--main-bg);
            color: var(--text-primary);
            font-family: 'Source Code Pro', monospace;
            line-height: 1.6;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(255, 42, 127, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 85% 30%, rgba(127, 42, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 50% 80%, rgba(42, 255, 127, 0.05) 0%, transparent 20%);
            min-height: 100vh;
            padding: 20px;
        }
        
        #app {
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        
        #header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
            border-bottom: 1px solid var(--terminal-border);
            text-shadow: 0 0 10px var(--terminal-glow);
        }
        
        #header h1 {
            font-family: 'Share Tech Mono', monospace;
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }
        
        #header p {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        
        #terminal-container {
            position: relative;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 25px var(--terminal-glow);
        }
        
        #terminal-header {
            background: linear-gradient(90deg, #151530, #0f0f25);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--terminal-border);
            font-size: 0.9rem;
        }
        
        #terminal-controls {
            display: flex;
            gap: 8px;
        }
        
        .control {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .control.close { background-color: #ff5f57; }
        .control.minimize { background-color: #ffbd2e; }
        .control.maximize { background-color: #28c940; }
        
        #terminal {
            background-color: var(--terminal-bg);
            height: 500px;
            padding: 20px;
            overflow-y: auto;
            background-image: 
                linear-gradient(rgba(10, 10, 24, 0.9), rgba(10, 10, 24, 0.9)),
                url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ff2a7f' fill-opacity='0.05' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            border: 1px solid var(--terminal-border);
        }
        
        #input-container {
            display: flex;
            align-items: center;
            background-color: rgba(10, 10, 24, 0.7);
            padding: 10px 15px;
            border: 1px solid var(--terminal-border);
            border-radius: 8px;
            box-shadow: 0 0 15px var(--terminal-glow);
        }
        
        #prompt {
            color: var(--text-command);
            margin-right: 10px;
            font-weight: bold;
            text-shadow: 0 0 5px var(--text-command);
        }
        
        #command-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Source Code Pro', monospace;
            font-size: 1rem;
            outline: none;
            caret-color: var(--text-primary);
            text-shadow: 0 0 5px var(--text-primary);
        }
        
        #scoreboard {
            margin-top: 30px;
            padding: 20px;
            background: rgba(10, 10, 24, 0.7);
            border: 1px solid var(--terminal-border);
            border-radius: 8px;
            box-shadow: 0 0 15px var(--terminal-glow);
        }
        
        #scoreboard h3 {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }
        
        #flags-found {
            color: var(--text-success);
            margin-left: 10px;
            font-size: 1.5rem;
            text-shadow: 0 0 8px var(--text-success);
        }
        
        #scoreboard p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            
        }
        
        .command {
            color: var(--text-command);
            margin-bottom: 10px;
            text-shadow: 0 0 5px var(--text-command);
        }
        
        .output {
            margin-bottom: 15px;
            white-space: pre-wrap;
            text-shadow: 0 0 3px var(--text-primary);
        }
        
        .error {
            color: var(--text-error);
            text-shadow: 0 0 5px var(--text-error);
        }
        
        .success {
            color: var(--text-success);
            font-weight: bold;
            text-shadow: 0 0 8px var(--text-success);
        }
        
        .warning {
            color: var(--text-warning);
            text-shadow: 0 0 5px var(--text-warning);
        }
        
        .directory {
            color: var(--text-secondary);
            text-shadow: 0 0 5px var(--text-secondary);
        }
        
        .file {
            color: var(--text-primary);
        }
        
        .executable {
            color: var(--text-command);
            text-shadow: 0 0 5px var(--text-command);
        }
        
        .encrypted {
            color: var(--accent-2);
            text-shadow: 0 0 5px var(--accent-2);
        }
        
        .virus-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #ff2a7f, #7f2aff);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 2.5rem;
            color: white;
            text-align: center;
            animation: virusPulse 0.3s infinite;
            font-family: 'Share Tech Mono', monospace;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
        }
        
        @keyframes virusPulse {
            0% { opacity: 0.9; }
            50% { opacity: 1; }
            100% { opacity: 0.9; }
        }
        
        .scan-line {
            position: fixed;
            width: 100%;
            height: 10px;
            background: linear-gradient(to bottom, 
                rgba(255, 42, 127, 0.3), 
                rgba(255, 42, 127, 0.1), 
                rgba(255, 42, 127, 0.3));
            z-index: 5;
            animation: scan 4s linear infinite;
            pointer-events: none;
        }
        
        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }
        
        .hacking-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 42, 127, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 42, 127, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: 1;
            pointer-events: none;
        }
        
        .glowing-particles {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 2;
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-20px) translateX(10px); }
            50% { transform: translateY(-40px) translateX(0); }
            75% { transform: translateY(-20px) translateX(-10px); }
            100% { transform: translateY(0) translateX(0); }
        }
        
        #hud {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .hud-item {
            background: rgba(10, 10, 24, 0.7);
            padding: 10px 15px;
            border: 1px solid var(--terminal-border);
            border-radius: 6px;
            box-shadow: 0 0 10px var(--terminal-glow);
            font-size: 0.9rem;
        }
        
        .hud-value {
            color: var(--text-success);
            font-weight: bold;
            text-shadow: 0 0 5px var(--text-success);
        }
        
        #matrix-rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.1;
            pointer-events: none;
        }
        
        #submit-section {
            margin-top: 20px;
            text-align: center;
        }
        
        #submit-button {
            background-color: var(--text-success);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            border-radius: 4px;
        }
        
        #return-button {
            margin-left: 10px;
            padding: 10px 20px;
            background: var(--text-secondary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Source Code Pro', monospace;
        }
        
        @media (max-width: 768px) {
            #header h1 {
                font-size: 2rem;
            }
            
            #terminal {
                height: 400px;
                padding: 15px;
            }
            
            #hud {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="scan-line"></div>
    <div class="hacking-grid"></div>
    <div class="glowing-particles" id="particles"></div>
    <canvas id="matrix-rain"></canvas>
    
    <div id="app">
        <div id="header">
            <h1>CYBER FOREST CTF CHAPTER 03: THE ENCRYPTED VAULT</h1>
            <p>Decrypt the secrets. Break the codes. Access the vault.</p>
        </div>
        
        <div id="hud">
            <div class="hud-item">System: <span class="hud-value">ENCRYPTED</span></div>
            <div class="hud-item">Security: <span class="hud-value">LEVEL 3</span></div>
            <div class="hud-item">Time: <span class="hud-value" id="timer">00:00:00</span></div>
        </div>
        
        <div id="terminal-container">
            <div id="terminal-header">
                <div>user@cybervault:~</div>
                <div id="terminal-controls">
                    <div class="control close"></div>
                    <div class="control minimize"></div>
                    <div class="control maximize"></div>
                </div>
            </div>
            <div id="terminal"></div>
        </div>
        
        <div id="input-container">
            <span id="prompt">user@cybervault:$</span>
            <input type="text" id="command-input" autofocus>
        </div>
        
        <div id="scoreboard">
            <h3>Flags Captured: <span id="flags-found">0</span>/5</h3>
            <p>Available commands: ls, cd, cat, file, help, clear, decode, base64, xor, cipher, find</p>
        </div>
        
        <div id="submit-section">
            <p>Found all flags? Submit your completion!</p>
            <button id="submit-button" onclick="submitCompletion()">Submit Completion</button>
            <button id="return-button" onclick="returnToTown()">Return to Town</button>
        </div>
    </div>

    <script>
        // Game state
        const state = {
            currentPath: "/",
            flagsFound: 0,
            infected: false,
            startTime: new Date(),
            endTime: null,
            foundFlags: {
                flag1: false,
                flag2: false,
                flag3: false,
                flag4: false,
                flag5: false
            },
            unlockedCrypto: false,
            completed: false,
            decodedMessages: 0
        };

        // Leaderboard data (stored in localStorage)
        let leaderboard = JSON.parse(localStorage.getItem('cyberForestLeaderboard')) || [];
        
        // File system structure
        const fileSystem = {
            "/": ["bin/", "home/", "var/", "etc/", "usr/", "vault/", "readme.txt", ".system_log"],
            "/bin/": ["ls", "cat", "file", "decode", "base64", "xor", "cipher", "find", "virus"],
            "/home/": ["user/", "crypto/", "admin/", "backup/", "note.txt"],
            "/home/user/": ["Documents/", "Downloads/", "Pictures/", "Music/", "Desktop/", ".hidden/", "message.enc"],
            "/home/user/Documents/": ["Work/", "Personal/", "Projects/", "notes.txt", "secret.docx", "flag1.enc"],
            "/home/user/Documents/Work/": ["Reports/", "Presentations/", "Q3_Summary.doc", "budget.xls"],
            "/home/user/Documents/Work/Reports/": ["2023/", "2024/", "template.doc"],
            "/home/user/Documents/Work/Reports/2024/": ["Q1_Report.pdf", "Q2_Report.pdf", "confidential.enc"],
            "/home/user/Documents/Personal/": ["Taxes/", "Recipes/", "Diary/", "notes.txt"],
            "/home/user/Documents/Personal/Taxes/": ["2023.pdf", "W2_forms.zip"],
            "/home/user/Documents/Projects/": ["CTF/", "Website/", "App/", "ideas.txt"],
            "/home/user/Documents/Projects/CTF/": ["challenge1.py", "challenge2.exe", "hint.txt", "encrypted_data.bin"],
            "/home/user/Downloads/": ["malware.exe", "clean_file.zip", "suspicious.rar", "crypto_tool.exe"],
            "/home/user/Pictures/": ["vacation.jpg", "forest.png", "screenshot.png", "memes/", "steganography/"],
            "/home/user/Pictures/memes/": ["funny1.jpg", "funny2.png"],
            "/home/user/Pictures/steganography/": ["image1.png", "image2.jpg", "hidden_message.txt"],
            "/home/user/Music/": ["song1.mp3", "song2.wav", "lyrics.txt"],
            "/home/user/Desktop/": ["shortcut.lnk", "temp_file", "notes.txt", "flag2.b64"],
            "/home/user/.hidden/": [".config", ".keys", "secret.txt"],
            "/home/crypto/": ["challenges/", "tools/", "readme.txt"],
            "/home/crypto/challenges/": ["caesar/", "vigenere/", "rsa/", "xor/", "base64/"],
            "/home/crypto/challenges/caesar/": ["ciphertext.txt", "hint.txt"],
            "/home/crypto/challenges/vigenere/": ["ciphertext.txt", "key_hint.txt"],
            "/home/crypto/challenges/rsa/": ["public.key", "message.rsa"],
            "/home/crypto/challenges/xor/": ["ciphertext.txt", "key.txt"],
            "/home/crypto/challenges/base64/": ["encoded.txt"],
            "/home/crypto/tools/": ["decoder.py", "encoder.exe", "stegsolve.jar"],
            "/home/admin/": ["logs/", "config/", "backups/", "admin_tools.exe"],
            "/home/admin/logs/": ["system.log", "auth.log", "debug.log"],
            "/home/admin/config/": ["server.cfg", "security.policy", "users.db"],
            "/home/admin/backups/": ["backup2024.zip", "system_backup.tar"],
            "/var/": ["log/", "lib/", "tmp/", "cache/"],
            "/var/log/": ["apache/", "system/", "install.log"],
            "/var/log/apache/": ["access.log", "error.log"],
            "/etc/": ["passwd", "shadow", "hosts", "config/"],
            "/etc/config/": ["network.cfg", "security.cfg", "crypto.cfg"],
            "/usr/": ["bin/", "lib/", "share/", "local/"],
            "/usr/share/": ["doc/", "man/", "misc/", "flags/"],
            "/usr/share/flags/": ["flag3.txt", "hint.txt"],
            "/vault/": ["level1/", "level2/", "level3/", "README"],
            "/vault/level1/": ["password.txt", "hint.txt"],
            "/vault/level2/": ["key.bin", "challenge.enc"],
            "/vault/level3/": ["final_flag.enc", "key_hint.txt"]
        };

        // File contents
        const fileContents = {
            "/readme.txt": "Welcome to the Encrypted Vault!\nThis system contains multiple layers of encryption.\nFind and decode all 5 flags to complete the challenge.",
            "/.system_log": "System booted successfully.\nEncryption protocols enabled.\nWarning: Multiple cryptographic challenges detected.",
            "/home/note.txt": "Important: The crypto tools in /home/crypto/ might be useful for decoding messages.",
            "/home/user/message.enc": "U2FsdGVkX1/5K3N5dXBlcm1hbiBpcyB0aGUga2V5IQ==\nHint: This is Base64 encoded. The password is 'superman'.",
            "/home/user/Documents/notes.txt": "Work Notes:\n- Finish quarterly report\n- Encrypt sensitive files\n- Change password every 90 days",
            "/home/user/Documents/secret.docx": "This document appears to be corrupted or encrypted.",
            "/home/user/Documents/flag1.enc": "U2FsdGVkX18R7xUZ6J6nD7Qy2w5Z6P4zX6Q5R5K7L8M9N0O1P2Q3R4S5T6U7V8W9X0Y1Z2\nHint: This is encrypted with OpenSSL. Password: 'cyberforest'",
            "/home/user/Documents/Work/Q3_Summary.doc": "Q3 Performance Summary:\n- Revenue: $1.5M\n- Expenses: $900K\n- Profit: $600K",
            "/home/user/Documents/Work/budget.xls": "Budget allocation for next year:\n- R&D: $250K\n- Marketing: $180K\n- Security: $120K",
            "/home/user/Documents/Work/Reports/template.doc": "Report Template\nUse this for all quarterly reports",
            "/home/user/Documents/Work/Reports/2024/Q1_Report.pdf": "Q1 2024 Financial Report\nAll targets met successfully",
            "/home/user/Documents/Work/Reports/2024/Q2_Report.pdf": "Q2 2024 Financial Report\nMarket conditions challenging\nProjections adjusted downward",
            "/home/user/Documents/Work/Reports/2024/confidential.enc": "This file is encrypted with AES-256. The key is hidden somewhere in the system.",
            "/home/user/Documents/Personal/notes.txt": "Personal reminder:\n- Buy groceries\n- Call dentist\n- Pay electricity bill",
            "/home/user/Documents/Personal/Taxes/2023.pdf": "2023 Tax Return\nFiled electronically April 15, 2024",
            "/home/user/Documents/Personal/Taxes/W2_forms.zip": "W2 Forms Archive\nContains tax documents for 2023",
            "/home/user/Documents/Projects/ideas.txt": "Project Ideas:\n- Smart home system\n- Mobile game app\n- AI assistant",
            "/home/user/Documents/Projects/CTF/challenge1.py": "print('Hello CTF player!')\n# This is a decoy file",
            "/home/user/Documents/Projects/CTF/challenge2.exe": "This executable file is corrupted",
            "/home/user/Documents/Projects/CTF/hint.txt": "The real flags are often hidden in plain sight",
            "/home/user/Documents/Projects/CTF/encrypted_data.bin": "U2FsdGVkX1+2w2Z6P4zX6Q5R5K7L8M9N0O1P2Q3R4S5T6U7V8W9X0Y1Z2\nThis data is encrypted with AES-256",
            "/home/user/Downloads/malware.exe": "VIRUS ACTIVATED! Your system is now compromised!",
            "/home/user/Downloads/clean_file.zip": "This archive contains nothing interesting.",
            "/home/user/Downloads/suspicious.rar": "This archive is password protected.",
            "/home/user/Downloads/crypto_tool.exe": "Crypto Tool v2.1\nUsage: crypto_tool [encode/decode] [file]",
            "/home/user/Pictures/vacation.jpg": "A nice picture of the beach. Nothing hidden here.",
            "/home/user/Pictures/forest.png": "A dense digital forest. Look closer...",
            "/home/user/Pictures/screenshot.png": "Screenshot of error message\nError code: 0x80070005",
            "/home/user/Pictures/memes/funny1.jpg": "Internet meme: 'One does not simply...'",
            "/home/user/Pictures/memes/funny2.png": "Meme: 'I have no idea what I'm doing'",
            "/home/user/Pictures/steganography/image1.png": "This image contains a hidden message. Use steganography tools to extract it.",
            "/home/user/Pictures/steganography/image2.jpg": "Another image with hidden data. Look for LSB encoding.",
            "/home/user/Pictures/steganography/hidden_message.txt": "The password for the vault level1 is: 'crypto123'",
            "/home/user/Music/song1.mp3": "Audio file metadata:\nArtist: Unknown\nTitle: Unknown\nDuration: 3:45",
            "/home/user/Music/song2.wav": "Raw audio data, no metadata",
            "/home/user/Music/lyrics.txt": "Song lyrics:\nNever gonna give you up\nNever gonna let you down",
            "/home/user/Desktop/shortcut.lnk": "Shortcut to important document\nTarget: /home/user/Documents/Work/Q3_Summary.doc",
            "/home/user/Desktop/temp_file": "Temporary file contents\nWill be deleted on reboot",
            "/home/user/Desktop/notes.txt": "Desktop notes:\n- Finish report\n- Email client\n- Buy coffee",
            "/home/user/Desktop/flag2.b64": "Q1RGe2Jhc2U2NF9lbmNvZGluZ19pc19lYXN5fQ==",
            "/home/user/.hidden/.config": "User configuration file\nContains personal settings",
            "/home/user/.hidden/.keys": "AES-256 key: cyberforest2024ctf\nUse this for confidential.enc",
            "/home/user/.hidden/secret.txt": "The vigenere cipher key is 'hiddenkey'",
            "/home/crypto/readme.txt": "Cryptography Challenge Hub\nHere you'll find various crypto challenges.\nComplete them to improve your skills.",
            "/home/crypto/challenges/caesar/ciphertext.txt": "Dwwdfn wr wkh F|Ehu Iruhvw FWI!",
            "/home/crypto/challenges/caesar/hint.txt": "Shift of 3",
            "/home/crypto/challenges/vigenere/ciphertext.txt": "Xmcwawa kmvq Qvmtckib Ctf!",
            "/home/crypto/challenges/vigenere/key_hint.txt": "The key is 8 letters long",
            "/home/crypto/challenges/rsa/public.key": "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwV7+2R0oOA2kX3zN4m7G\nk4K5X5L6M7N8O9P0Q1R2S3T4U5V6W7X8Y9Z0A1B2C3D4E5F6G7H8I9J0K1L2M3N4\nO5P6Q7R8S9T0U1V2W3X4Y5Z6A7B8C9D0E1F2G3H4I5J6K7L8M9N0O1P2Q3R4S5T6\nU7V8W9X0Y1Z2A3B4C5D6E7F8G9H0I1J2K3L4M5N6O7P8Q9R0S1T2U3V4W5X6Y7Z8\nA9B0C1D2E3F4G5H6I7J8K9L0M1N2O3P4Q5R6S7T8U9V0W1X2Y3Z4A5B6C7D8E9F0\nG1H2I3J4K5L6M7N8O9P0Q1R2S3T4U5V6W7X8Y9Z0A1B2C3D4E5F6G7H8I9J0K1L2\nMwIDAQAB\n-----END PUBLIC KEY-----",
            "/home/crypto/challenges/rsa/message.rsa": "This message is encrypted with RSA. You'll need the private key to decrypt it.",
            "/home/crypto/challenges/xor/ciphertext.txt": "5d41402abc4b2a76b9719d911017c592",
            "/home/crypto/challenges/xor/key.txt": "key",
            "/home/crypto/challenges/base64/encoded.txt": "VGhlIGZsYWcgaXM6IENURntiYXNpY182NF9kZWNvZGV9",
            "/home/crypto/tools/decoder.py": "#!/usr/bin/python3\n# Simple decoder tool\nimport base64\nprint('Base64 decoder ready')",
            "/home/crypto/tools/encoder.exe": "Encoder tool v1.0\nConverts text to various encodings",
            "/home/crypto/tools/stegsolve.jar": "Steganography tool for extracting hidden data from images",
            "/home/admin/logs/system.log": "System log:\nServices started successfully\nNo errors detected",
            "/home/admin/logs/auth.log": "Authentication log:\nUser admin logged in\nFailed login attempt: user123",
            "/home/admin/logs/debug.log": "Debug messages:\nMemory allocation: 2GB\nCPU usage: 15%",
            "/home/admin/config/server.cfg": "Server configuration:\nPort: 8080\nTimeout: 30s\nSSL: enabled",
            "/home/admin/config/security.policy": "Security policy:\nPassword length: 12 chars\nLockout after 5 attempts",
            "/home/admin/config/users.db": "User database encrypted",
            "/home/admin/backups/backup2024.zip": "System backup from January 2024",
            "/home/admin/backups/system_backup.tar": "Full system backup\nSize: 15GB",
            "/home/admin/admin_tools.exe": "Administrative tools suite\nRequires elevation",
            "/var/log/install.log": "Software installation log:\nPackage: text-editor\nStatus: success",
            "/var/log/apache/access.log": "Web server access log:\n127.0.0.1 - GET /index.html\n192.168.1.5 - POST /login",
            "/var/log/apache/error.log": "Web server errors:\n500 Internal Server Error\n404 File Not Found",
            "/etc/passwd": "root:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin",
            "/etc/shadow": "root:$6$rounds=656000$W2aH6lGjM3eKp.9Q$W8lLkZ7X2jH5fD3gS6hF7dK9J2lL3mN5bV8cX1zM4pQ7wR6tY9vB0n:19285:0:99999:7::\ndaemon:*:19284:0:99999:7::\nbin:*:19284:0:99999:7::\nsys:*:19284:0:99999:7::",
            "/etc/hosts": "127.0.0.1 localhost\n127.0.1.1 cybervault\n\n# The following lines are desirable for IPv6 capable hosts\n::1 localhost ip6-localhost ip6-loopback\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters",
            "/etc/config/network.cfg": "Network configuration:\nIP: 192.168.1.100\nNetmask: 255.255.255.0\nGateway: 192.168.1.1",
            "/etc/config/security.cfg": "Security settings:\nFirewall: enabled\nIDS: enabled\nEncryption: AES-256",
            "/etc/config/crypto.cfg": "Cryptographic settings:\nDefault algorithm: AES-256\nKey length: 256 bits\nHash: SHA-256",
            "/usr/share/flags/flag3.txt": "CTF{file_system_exploration}",
            "/usr/share/flags/hint.txt": "The next flag is in the vault. Start with level1.",
            "/vault/README": "VAULT ACCESS SYSTEM\nThis vault contains 3 security levels.\nEach level requires solving a cryptographic challenge.\nFind the keys and passwords throughout the system.",
            "/vault/level1/password.txt": "The password for level2 is: 'xor_is_fun'",
            "/vault/level1/hint.txt": "Use the password from the steganography image",
            "/vault/level2/key.bin": "01111010 01100101 01110010 01101111 01100011 01101111 01101110 01110100 01110010 01101111 01101100", // zerocontrol in binary
            "/vault/level2/challenge.enc": "This file is encrypted with XOR. The key is in key.bin.",
            "/vault/level3/final_flag.enc": "U2FsdGVkX1/5K3N5dXBlcm1hbiBpcyB0aGUga2V5IQ==", // Base64 encoded "Superman is the key!" but actually "CTF{master_of_encryption}"
            "/vault/level3/key_hint.txt": "The key is the answer to the life, the universe, and everything" // 42
        };

        // File types (for 'file' command)
        const fileTypes = {
            "/readme.txt": "ASCII text",
            "/.system_log": "ASCII text",
            "/home/note.txt": "ASCII text",
            "/home/user/message.enc": "Base64 encoded text",
            "/home/user/Documents/notes.txt": "ASCII text",
            "/home/user/Documents/secret.docx": "Microsoft Word 2007+",
            "/home/user/Documents/flag1.enc": "OpenSSL encrypted data",
            "/home/user/Documents/Work/Q3_Summary.doc": "Microsoft Word 97-2003",
            "/home/user/Documents/Work/budget.xls": "Microsoft Excel 97-2003",
            "/home/user/Documents/Work/Reports/template.doc": "Microsoft Word 2007+",
            "/home/user/Documents/Work/Reports/2024/Q1_Report.pdf": "PDF document",
            "/home/user/Documents/Work/Reports/2024/Q2_Report.pdf": "PDF document",
            "/home/user/Documents/Work/Reports/
            "/home/user/Documents/Work/Reports/2024/confidential.enc": "AES-256 encrypted data",
            "/home/user/Documents/Personal/notes.txt": "ASCII text",
            "/home/user/Documents/Personal/Taxes/2023.pdf": "PDF document",
            "/home/user/Documents/Personal/Taxes/W2_forms.zip": "Zip archive data",
            "/home/user/Documents/Projects/ideas.txt": "ASCII text",
            "/home/user/Documents/Projects/CTF/challenge1.py": "Python script",
            "/home/user/Documents/Projects/CTF/challenge2.exe": "PE32 executable",
            "/home/user/Documents/Projects/CTF/hint.txt": "ASCII text",
            "/home/user/Documents/Projects/CTF/encrypted_data.bin": "AES-256 encrypted data",
            "/home/user/Downloads/malware.exe": "PE32 executable (GUI) Intel 80386",
            "/home/user/Downloads/clean_file.zip": "Zip archive data",
            "/home/user/Downloads/suspicious.rar": "RAR archive data",
            "/home/user/Downloads/crypto_tool.exe": "PE32 executable",
            "/home/user/Pictures/vacation.jpg": "JPEG image data",
            "/home/user/Pictures/forest.png": "PNG image data",
            "/home/user/Pictures/screenshot.png": "PNG image data",
            "/home/user/Pictures/memes/funny1.jpg": "JPEG image data",
            "/home/user/Pictures/memes/funny2.png": "PNG image data",
            "/home/user/Pictures/steganography/image1.png": "PNG image data",
            "/home/user/Pictures/steganography/image2.jpg": "JPEG image data",
            "/home/user/Pictures/steganography/hidden_message.txt": "ASCII text",
            "/home/user/Music/song1.mp3": "MP3 audio",
            "/home/user/Music/song2.wav": "RIFF (little-endian) data, WAVE audio",
            "/home/user/Music/lyrics.txt": "ASCII text",
            "/home/user/Desktop/shortcut.lnk": "MS Windows shortcut",
            "/home/user/Desktop/temp_file": "ASCII text",
            "/home/user/Desktop/notes.txt": "ASCII text",
            "/home/user/Desktop/flag2.b64": "Base64 encoded text",
            "/home/user/.hidden/.config": "ASCII text",
            "/home/user/.hidden/.keys": "ASCII text",
            "/home/user/.hidden/secret.txt": "ASCII text",
            "/home/crypto/readme.txt": "ASCII text",
            "/home/crypto/challenges/caesar/ciphertext.txt": "ASCII text",
            "/home/crypto/challenges/caesar/hint.txt": "ASCII text",
            "/home/crypto/challenges/vigenere/ciphertext.txt": "ASCII text",
            "/home/crypto/challenges/vigenere/key_hint.txt": "ASCII text",
            "/home/crypto/challenges/rsa/public.key": "OpenSSL public key",
            "/home/crypto/challenges/rsa/message.rsa": "RSA encrypted data",
            "/home/crypto/challenges/xor/ciphertext.txt": "ASCII text",
            "/home/crypto/challenges/xor/key.txt": "ASCII text",
            "/home/crypto/challenges/base64/encoded.txt": "Base64 encoded text",
            "/home/crypto/tools/decoder.py": "Python script",
            "/home/crypto/tools/encoder.exe": "PE32 executable",
            "/home/crypto/tools/stegsolve.jar": "Java archive data",
            "/home/admin/logs/system.log": "ASCII text",
            "/home/admin/logs/auth.log": "ASCII text",
            "/home/admin/logs/debug.log": "ASCII text",
            "/home/admin/config/server.cfg": "ASCII text",
            "/home/admin/config/security.policy": "ASCII text",
            "/home/admin/config/users.db": "data",
            "/home/admin/backups/backup2024.zip": "Zip archive data",
            "/home/admin/backups/system_backup.tar": "POSIX tar archive",
            "/home/admin/admin_tools.exe": "PE32 executable",
            "/var/log/install.log": "ASCII text",
            "/var/log/apache/access.log": "ASCII text",
            "/var/log/apache/error.log": "ASCII text",
            "/etc/passwd": "ASCII text",
            "/etc/shadow": "ASCII text",
            "/etc/hosts": "ASCII text",
            "/etc/config/network.cfg": "ASCII text",
            "/etc/config/security.cfg": "ASCII text",
            "/etc/config/crypto.cfg": "ASCII text",
            "/usr/share/flags/flag3.txt": "ASCII text",
            "/usr/share/flags/hint.txt": "ASCII text",
            "/vault/README": "ASCII text",
            "/vault/level1/password.txt": "ASCII text",
            "/vault/level1/hint.txt": "ASCII text",
            "/vault/level2/key.bin": "ASCII text",
            "/vault/level2/challenge.enc": "data",
            "/vault/level3/final_flag.enc": "Base64 encoded text",
            "/vault/level3/key_hint.txt": "ASCII text"
        };

        // DOM elements
        const terminal = document.getElementById('terminal');
        const commandInput = document.getElementById('command-input');
        const flagsFoundElement = document.getElementById('flags-found');
        const timerElement = document.getElementById('timer');

        // Initialize the terminal
        function initTerminal() {
            addOutput("Cyber Forest CTF - The Encrypted Vault");
            addOutput("Type 'help' for available commands.");
            addOutput("----------------------------------------");
            updatePrompt();
            
            // Start the timer
            setInterval(updateTimer, 1000);
            
            // Create particles
            createParticles();
            
            // Start matrix rain animation
            initMatrixRain();
        }

        // Update the command prompt
        function updatePrompt() {
            const promptElement = document.getElementById('prompt');
            promptElement.textContent = `user@cybervault:${state.currentPath}$`;
        }

        // Add output to the terminal
        function addOutput(text, className = '') {
            const outputElement = document.createElement('div');
            if (className) {
                outputElement.className = className;
            }
            outputElement.textContent = text;
            terminal.appendChild(outputElement);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Process commands
        function processCommand(command) {
            if (!command) return;
            
            // Add command to terminal
            addOutput(`user@cybervault:${state.currentPath}$ ${command}`, 'command');
            
            const args = command.split(' ');
            const cmd = args[0].toLowerCase();
            
            switch(cmd) {
                case 'help':
                    showHelp();
                    break;
                case 'ls':
                    listDirectory(args[1]);
                    break;
                case 'cd':
                    changeDirectory(args[1]);
                    break;
                case 'cat':
                    showFileContents(args[1]);
                    break;
                case 'file':
                    showFileType(args[1]);
                    break;
                case 'clear':
                    clearTerminal();
                    break;
                case 'decode':
                    decodeContent(args[1], args[2]);
                    break;
                case 'base64':
                    base64Operation(args[1], args[2]);
                    break;
                case 'xor':
                    xorOperation(args[1], args[2], args[3]);
                    break;
                case 'cipher':
                    cipherOperation(args[1], args[2], args[3]);
                    break;
                case 'find':
                    findFile(args[1]);
                    break;
                default:
                    addOutput(`Command not found: ${cmd}`, 'error');
            }
        }

        // Show help information
        function showHelp() {
            addOutput("Available commands:");
            addOutput("  ls [dir]        - List directory contents");
            addOutput("  cd [dir]        - Change directory");
            addOutput("  cat [file]      - Display file contents");
            addOutput("  file [file]     - Determine file type");
            addOutput("  clear           - Clear the terminal");
            addOutput("  decode [method] [file] - Decode file contents");
            addOutput("  base64 [decode/encode] [text/file] - Base64 operations");
            addOutput("  xor [key] [file] - XOR decryption");
            addOutput("  cipher [type] [key] [file] - Cipher decryption (caesar, vigenere)");
            addOutput("  find [pattern]  - Find files matching pattern");
            addOutput("  help            - Show this help message");
        }

        // List directory contents
        function listDirectory(path = '') {
            let targetPath = state.currentPath;
            
            if (path) {
                if (path.startsWith('/')) {
                    targetPath = path;
                } else {
                    targetPath = state.currentPath + (state.currentPath.endsWith('/') ? '' : '/') + path;
                }
                
                // Handle parent directory
                if (path === '..') {
                    const parts = state.currentPath.split('/').filter(part => part);
                    parts.pop();
                    targetPath = '/' + parts.join('/');
                    if (targetPath === '') targetPath = '/';
                }
            }
            
            // Normalize path
            if (!targetPath.endsWith('/')) {
                targetPath += '/';
            }
            
            if (fileSystem[targetPath]) {
                const contents = fileSystem[targetPath];
                let output = '';
                
                contents.forEach(item => {
                    if (item.endsWith('/')) {
                        output += `<span class="directory">${item}</span> `;
                    } else if (item.endsWith('.enc') || item.endsWith('.b64') || item.endsWith('.bin') || 
                              item.endsWith('.rsa') || item.endsWith('.key')) {
                        output += `<span class="encrypted">${item}</span> `;
                    } else if (item.endsWith('.exe') || item.endsWith('.jar') || item.endsWith('.py')) {
                        output += `<span class="executable">${item}</span> `;
                    } else {
                        output += `<span class="file">${item}</span> `;
                    }
                });
                
                addOutput(output);
            } else {
                addOutput(`ls: cannot access '${path}': No such file or directory`, 'error');
            }
        }

        // Change directory
        function changeDirectory(path) {
            if (!path) {
                state.currentPath = '/';
                updatePrompt();
                return;
            }
            
            let targetPath = state.currentPath;
            
            if (path.startsWith('/')) {
                targetPath = path;
            } else {
                if (state.currentPath.endsWith('/')) {
                    targetPath = state.currentPath + path;
                } else {
                    targetPath = state.currentPath + '/' + path;
                }
            }
            
            // Handle parent directory
            if (path === '..') {
                const parts = state.currentPath.split('/').filter(part => part);
                parts.pop();
                targetPath = '/' + parts.join('/');
                if (targetPath === '') targetPath = '/';
            }
            
            // Ensure path ends with slash for directory lookup
            if (!targetPath.endsWith('/')) {
                targetPath += '/';
            }
            
            if (fileSystem[targetPath]) {
                state.currentPath = targetPath;
                updatePrompt();
            } else {
                addOutput(`cd: no such directory: ${path}`, 'error');
            }
        }

        // Show file contents
        function showFileContents(filename) {
            if (!filename) {
                addOutput('cat: missing file operand', 'error');
                return;
            }
            
            let filePath;
            
            if (filename.startsWith('/')) {
                filePath = filename;
            } else {
                filePath = state.currentPath + (state.currentPath.endsWith('/') ? '' : '/') + filename;
            }
            
            if (fileContents[filePath]) {
                // Check for special files that trigger events
                if (filePath === '/home/user/Downloads/malware.exe') {
                    activateVirus();
                }
                
                // Check for flags
                if (filePath === '/usr/share/flags/flag3.txt' && !state.foundFlags.flag3) {
                    state.foundFlags.flag3 = true;
                    state.flagsFound++;
                    flagsFoundElement.textContent = state.flagsFound;
                    addOutput('Flag captured!', 'success');
                }
                
                if (filePath === '/home/user/Desktop/flag2.b64' && !state.foundFlags.flag2) {
                    state.foundFlags.flag2 = true;
                    state.flagsFound++;
                    flagsFoundElement.textContent = state.flagsFound;
                    addOutput('Flag captured!', 'success');
                }
                
                addOutput(fileContents[filePath]);
            } else {
                addOutput(`cat: ${filename}: No such file or directory`, 'error');
            }
        }

        // Show file type
        function showFileType(filename) {
            if (!filename) {
                addOutput('file: missing file operand', 'error');
                return;
            }
            
            let filePath;
            
            if (filename.startsWith('/')) {
                filePath = filename;
            } else {
                filePath = state.currentPath + (state.currentPath.endsWith('/') ? '' : '/') + filename;
            }
            
            if (fileTypes[filePath]) {
                addOutput(`${filename}: ${fileTypes[filePath]}`);
            } else {
                addOutput(`file: ${filename}: No such file or directory`, 'error');
            }
        }

        // Clear terminal
        function clearTerminal() {
            terminal.innerHTML = '';
        }

        // Decode content
        function decodeContent(method, filename) {
            if (!method || !filename) {
                addOutput('decode: missing operand(s)', 'error');
                addOutput('Usage: decode [method] [file]', 'error');
                addOutput('Methods: base64, xor, caesar, vigenere', 'error');
                return;
            }
            
            let filePath;
            
            if (filename.startsWith('/')) {
                filePath = filename;
            } else {
                filePath = state.currentPath + (state.currentPath.endsWith('/') ? '' : '/') + filename;
            }
            
            if (!fileContents[filePath]) {
                addOutput(`decode: ${filename}: No such file or directory`, 'error');
                return;
            }
            
            const content = fileContents[filePath];
            let decoded = '';
            
            switch(method.toLowerCase()) {
                case 'base64':
                    try {
                        decoded = atob(content.trim());
                        addOutput(`Base64 decoded: ${decoded}`);
                        state.decodedMessages++;
                    } catch (e) {
                        addOutput('Error: Invalid Base64 string', 'error');
                    }
                    break;
                    
                case 'xor':
                    addOutput('XOR decoding requires a key. Use: xor [key] [file]', 'warning');
                    break;
                    
                case 'caesar':
                    // Simple Caesar cipher decoder (shift of 3)
                    decoded = caesarDecode(content, 3);
                    addOutput(`Caesar decoded: ${decoded}`);
                    state.decodedMessages++;
                    break;
                    
                case 'vigenere':
                    addOutput('Vigenère decoding requires a key. Use: cipher vigenere [key] [file]', 'warning');
                    break;
                    
                default:
                    addOutput(`decode: unknown method: ${method}`, 'error');
            }
            
            // Check if this decoding reveals a flag
            if (filePath === '/home/crypto/challenges/caesar/ciphertext.txt' && decoded.includes('CTF{')) {
                if (!state.foundFlags.flag4) {
                    state.foundFlags.flag4 = true;
                    state.flagsFound++;
                    flagsFoundElement.textContent = state.flagsFound;
                    addOutput('Flag captured!', 'success');
                }
            }
        }

        // Base64 operations
        function base64Operation(operation, input) {
            if (!operation || !input) {
                addOutput('base64: missing operand(s)', 'error');
                addOutput('Usage: base64 [decode/encode] [text/file]', 'error');
                return;
            }
            
            let content = input;
            
            // Check if input is a file path
            if (input.startsWith('/') || input.includes('/')) {
                let filePath;
                
                if (input.startsWith('/')) {
                    filePath = input;
                } else {
                    filePath = state.currentPath + (state.currentPath.endsWith('/') ? '' : '/') + input;
                }
                
                if (fileContents[filePath]) {
                    content = fileContents[filePath];
                }
            }
            
            switch(operation.toLowerCase()) {
                case 'decode':
                    try {
                        const decoded = atob(content.trim());
                        addOutput(`Base64 decoded: ${decoded}`);
                        state.decodedMessages++;
                        
                        // Check if this is a flag
                        if (decoded.includes('CTF{')) {
                            if (input === 'flag2.b64' && !state.foundFlags.flag2) {
                                state.foundFlags.flag2 = true;
                                state.flagsFound++;
                                flagsFoundElement.textContent = state.flagsFound;
                                addOutput('Flag captured!', 'success');
                            }
                        }
                    } catch (e) {
                        addOutput('Error: Invalid Base64 string', 'error');
                    }
                    break;
                    
                case 'encode':
                    const encoded = btoa(content);
                    addOutput(`Base64 encoded: ${encoded}`);
                    break;
                    
                default:
                    addOutput(`base64: unknown operation: ${operation}`, 'error');
            }
        }

        // XOR operation
        function xorOperation(key, filename) {
            if (!key || !filename) {
                addOutput('xor: missing operand(s)', 'error');
                addOutput('Usage: xor [key] [file]', 'error');
                return;
            }
            
            let filePath;
            
            if (filename.startsWith('/')) {
                filePath = filename;
            } else {
                filePath = state.currentPath + (state.currentPath.endsWith('/') ? '' : '/') + filename;
            }
            
            if (!fileContents[filePath]) {
                addOutput(`xor: ${filename}: No such file or directory`, 'error');
                return;
            }
            
            const content = fileContents[filePath];
            let result = '';
            
            // Simple XOR implementation
            for (let i = 0; i < content.length; i++) {
                const charCode = content.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                result += String.fromCharCode(charCode);
            }
            
            addOutput(`XOR decrypted: ${result}`);
            state.decodedMessages++;
            
            // Check if this is a flag
            if (result.includes('CTF{')) {
                if (filePath === '/vault/level2/challenge.enc' && !state.foundFlags.flag5) {
                    state.foundFlags.flag5 = true;
                    state.flagsFound++;
                    flagsFoundElement.textContent = state.flagsFound;
                    addOutput('Flag captured!', 'success');
                }
            }
        }

        // Cipher operations
        function cipherOperation(type, key, filename) {
            if (!type || !key || !filename) {
                addOutput('cipher: missing operand(s)', 'error');
                addOutput('Usage: cipher [type] [key] [file]', 'error');
                addOutput('Types: caesar, vigenere', 'error');
                return;
            }
            
            let filePath;
            
            if (filename.startsWith('/')) {
                filePath = filename;
            } else {
                filePath = state.currentPath + (state.currentPath.endsWith('/') ? '' : '/') + filename;
            }
            
            if (!fileContents[filePath]) {
                addOutput(`cipher: ${filename}: No such file or directory`, 'error');
                return;
            }
            
            const content = fileContents[filePath];
            let result = '';
            
            switch(type.toLowerCase()) {
                case 'caesar':
                    const shift = parseInt(key);
                    if (isNaN(shift)) {
                        addOutput('cipher: caesar key must be a number', 'error');
                        return;
                    }
                    result = caesarDecode(content, shift);
                    break;
                    
                case 'vigenere':
                    result = vigenereDecode(content, key);
                    break;
                    
                default:
                    addOutput(`cipher: unknown type: ${type}`, 'error');
                    return;
            }
            
            addOutput(`${type} decrypted: ${result}`);
            state.decodedMessages++;
            
            // Check if this is a flag
            if (result.includes('CTF{')) {
                if (filePath === '/home/crypto/challenges/vigenere/ciphertext.txt' && !state.foundFlags.flag4) {
                    state.foundFlags.flag4 = true;
                    state.flagsFound++;
                    flagsFoundElement.textContent = state.flagsFound;
                    addOutput('Flag captured!', 'success');
                }
            }
        }

        // Find file
        function findFile(pattern) {
            if (!pattern) {
                addOutput('find: missing pattern', 'error');
                return;
            }
            
            addOutput(`Searching for files matching: ${pattern}`);
            
            const results = [];
            const searchRegex = new RegExp(pattern.replace('*', '.*'));
            
            for (const path in fileSystem) {
                const files = fileSystem[path];
                
                for (const file of files) {
                    if (searchRegex.test(file)) {
                        results.push(path + file);
                    }
                }
            }
            
            if (results.length > 0) {
                results.forEach(result => {
                    addOutput(result);
                });
            } else {
                addOutput('No files found', 'warning');
            }
        }

        // Caesar cipher decoder
        function caesarDecode(text, shift) {
            let result = '';
            
            for (let i = 0; i < text.length; i++) {
                let char = text[i];
                
                if (char.match(/[a-z]/i)) {
                    const code = text.charCodeAt(i);
                    
                    // Uppercase letters
                    if (code >= 65 && code <= 90) {
                        char = String.fromCharCode(((code - 65 - shift + 26) % 26) + 65);
                    }
                    // Lowercase letters
                    else if (code >= 97 && code <= 122) {
                        char = String.fromCharCode(((code - 97 - shift + 26) % 26) + 97);
                    }
                }
                
                result += char;
            }
            
            return result;
        }

        // Vigenère cipher decoder
        function vigenereDecode(text, key) {
            let result = '';
            key = key.toUpperCase();
            
            for (let i = 0, j = 0; i < text.length; i++) {
                let char = text[i];
                
                if (char.match(/[a-z]/i)) {
                    const code = text.charCodeAt(i);
                    
                    // Uppercase letters
                    if (code >= 65 && code <= 90) {
                        char = String.fromCharCode(((code - 65 - (key.charCodeAt(j % key.length) - 65) + 26) % 26) + 65);
                        j++;
                    }
                    // Lowercase letters
                    else if (code >= 97 && code <= 122) {
                        char = String.fromCharCode(((code - 97 - (key.charCodeAt(j % key.length) - 65) + 26) % 26) + 97);
                        j++;
                    }
                }
                
                result += char;
            }
            
            return result;
        }

        // Activate virus effect
        function activateVirus() {
            if (state.infected) return;
            
            state.infected = true;
            const virusEffect = document.createElement('div');
            virusEffect.className = 'virus-effect';
            virusEffect.innerHTML = '<div>VIRUS DETECTED!</div><div>SYSTEM COMPROMISED</div>';
            document.body.appendChild(virusEffect);
            
            setTimeout(() => {
                document.body.removeChild(virusEffect);
                addOutput('Warning: Malware executed! System may be unstable.', 'error');
            }, 3000);
        }

        // Update timer
        function updateTimer() {
            const now = new Date();
            const elapsed = new Date(now - state.startTime);
            
            const hours = elapsed.getUTCHours().toString().padStart(2, '0');
            const minutes = elapsed.getUTCMinutes().toString().padStart(2, '0');
            const seconds = elapsed.getUTCSeconds().toString().padStart(2, '0');
            
            timerElement.textContent = `${hours}:${minutes}:${seconds}`;
        }

        // Create particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const colors = ['#ff2a7f', '#7f2aff', '#2aff7f', '#2a7fff'];
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random properties
                const size = Math.random() * 10 + 5;
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.background = color;
                particle.style.boxShadow = `0 0 ${size * 2}px ${size}px ${color}`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 20 + 10}s`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize matrix rain animation
        function initMatrixRain() {
            const canvas = document.getElementById('matrix-rain');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const characters = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const fontSize = 14;
            const columns = canvas.width / fontSize;
            
            const drops = [];
            for (let i = 0; i < columns; i++) {
                drops[i] = 1;
            }
            
            function draw() {
                ctx.fillStyle = 'rgba(10, 10, 24, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#00ffcc';
                ctx.font = `${fontSize}px monospace`;
                
                for (let i = 0; i < drops.length; i++) {
                    const text = characters.charAt(Math.floor(Math.random() * characters.length));
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    
                    drops[i]++;
                }
            }
            
            setInterval(draw, 33);
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // Submit completion
        function submitCompletion() {
            if (state.flagsFound === 5) {
                state.endTime = new Date();
                const timeTaken = new Date(state.endTime - state.startTime);
                
                const hours = timeTaken.getUTCHours().toString().padStart(2, '0');
                const minutes = timeTaken.getUTCMinutes().toString().padStart(2, '0');
                const seconds = timeTaken.getUTCSeconds().toString().padStart(2, '0');
                
                const completionTime = `${hours}:${minutes}:${seconds}`;
                
                // Add to leaderboard
                leaderboard.push({
                    name: 'Player',
                    time: completionTime,
                    date: new Date().toLocaleDateString()
                });
                
                // Sort by time
                leaderboard.sort((a, b) => {
                    const aTime = a.time.split(':').reduce((acc, time) => (60 * acc) + +time, 0);
                    const bTime = b.time.split(':').reduce((acc, time) => (60 * acc) + +time, 0);
                    return aTime - bTime;
                });
                
                // Keep top 10
                leaderboard = leaderboard.slice(0, 10);
                
                // Save to localStorage
                localStorage.setItem('cyberForestLeaderboard', JSON.stringify(leaderboard));
                
                addOutput('Challenge completed! Your time has been recorded.', 'success');
                state.completed = true;
            } else {
                addOutput(`You have found ${state.flagsFound} out of 5 flags. Keep searching!`, 'warning');
            }
        }

        // Return to town
        function returnToTown() {
            addOutput('Returning to Cyber Forest Town...', 'success');
            // In a real implementation, this would redirect to the main town page
        }

        // Event listeners
        commandInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const command = commandInput.value.trim();
                commandInput.value = '';
                processCommand(command);
            }
        });

        // Initialize the terminal when the page loads
        window.onload = initTerminal;
    </script>
</body>
</html>
